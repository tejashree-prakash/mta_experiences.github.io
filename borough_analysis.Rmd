---
title: "Borough Analysis"
output: html_document
---


```{r, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(plotly)
library(viridis)
library(readxl)
library(treemapify)
library(dplyr)
```

```{r, include=FALSE}
subway_rider_data = 
  read_csv("data/2019_Subway_Rider_Survey_20251121.csv") |> 
  janitor::clean_names()


subway_drops =
  subway_rider_data |> 
  select(-survey_stop_borough, -survey_stop_location) |> 
  drop_na() |> 
  mutate(survey_id = row_number()) |> 
  relocate(survey_id, .before = 1)


rider_data =
  subway_drops |>
  mutate(
    use_of_subway_frequency = case_when(
      use_of_subway_frequency == "Everyday / Almost everyday" ~ "Every day",
      use_of_subway_frequency == "More than once a week, varies" ~ "Several times a week",
      use_of_subway_frequency %in% c("Weekdays, Mon - Fri", "~5 days per week") ~ "5 days per week",
      use_of_subway_frequency == "Once a week" ~ "Once a week",
      use_of_subway_frequency == "Once a month" ~ "Once a month",
      use_of_subway_frequency == "Almost never" ~ "Almost never",
      use_of_subway_frequency == "Never" ~ "Never",
      TRUE ~ NA_character_
    ),
    use_of_subway_frequency = 
      factor(
        use_of_subway_frequency,
        levels = c("Never", 
                   "Almost never", 
                   "Once a month", 
                   "Once a week",
                   "Several times a week", 
                   "5 days per week", 
                   "Every day"),
        ordered = TRUE)
    )


rider_data =
  subway_drops |> 
  mutate(average_length_subway_ride = 
           factor(average_length_subway_ride,
                  levels = c("< 20 min", 
                             "20 - 40 min", 
                             "40 - 60 min",
                             "60 - 90 min", 
                             "90 min - 2 hours"),
                  ordered = TRUE))


rider_data =
  subway_drops |>
  mutate(
    overall_satisfaction = 
      recode(
        overall_satisfaction,
        "Not satisfied" = "Unsatisfied"),
    overall_satisfaction = 
      factor(
        overall_satisfaction,
        levels = c("Highly unsatisfied",
                 "Unsatisfied",
                 "Neutral",
                 "Somewhat satisfied",
                 "Very satisfied"),
      ordered = TRUE)
    )


rider_data =
  subway_drops |> 
  mutate(
    frequency_of_delays = factor(
      frequency_of_delays,
      levels = c("Everyday",
                 "A few times a week",
                 "Rarely",
                 "Almost never",
                 "Never"),
      ordered = TRUE)
    )


rider_data = 
  rider_data |> 
  mutate(
    is_subway_affordable = if_else(
      is_subway_affordable == "Yes", TRUE, FALSE),
    zip_code = as.character(zip_code)
    )


rider_data =
  rider_data |> 
  mutate(
    across(c(subway_line_used_most_often,
             get_to_subway_via,
             primary_use_of_subway,
             alternative_transport), as.factor)
  )

rider_data = 
  rider_data %>%
  mutate(
    top_three_complaints = 
      str_remove_all(top_three_complaints, "\\[|\\]|'")
  )

zip_code_data = 
  read_csv("data/nyc_zipcodes.csv") %>%
  select(borough, zipcode)


#Make sure character variables 
zip_code_data <- zip_code_data %>%
  mutate(zipcode = as.character(zipcode)) #make sure it's a character variable 
rider_data <- rider_data %>%
  mutate(zip_code = as.character(zip_code))

#Join
rider_data_full <- rider_data %>%
  left_join(zip_code_data, by = c("zip_code" = "zipcode"))

#Fill borough where missing
rider_data_full <- rider_data_full %>%
  mutate(borough = coalesce(borough, as.character(zip_code)))

#Remove invalid zip codes
rider_data_full <- rider_data_full %>%
  filter(survey_id != 2410) %>% 
  filter(survey_id != 944) %>% 
  filter(survey_id != 241) %>% 
  filter(survey_id != 919) 

# I added this ( adding the complaint variable)
rider_data_full <- rider_data_full |>
  mutate(
    complaint = str_split(top_three_complaints, ",\\s*")
  ) |>
  tidyr::unnest(complaint)

# Creating a complaint_data_time dataset (I added this)
complaint_data_time <- rider_data_full |> 
  mutate(
    submitted_at = mdy_hm(submitted_at),
    hour = hour(submitted_at),
    time_of_day = case_when(
      hour >= 6 & hour < 12 ~ "Morning",  #6 am to 11:59 am
      hour >= 12 & hour < 17 ~ "Afternoon", #12 pm to 4:59 pm
      hour >= 17 & hour < 21 ~ "Evening",  #5pm to 8:59 pm
      TRUE ~ "Night" # 9pm to 5:59 am 
    ),
    time_of_day = factor(time_of_day, 
                        levels = c("Morning", "Afternoon", "Evening", "Night"))
  )



```

The Borough Analysis was conducted to examine how perceptions of the MTA and operational metrics vary across the five boroughs of New York City as well as regions outside of NYC. The goal of this borough analysis is to highlight meaningful differences in rider sentiment and system performance that may help us understand how influential borough is in how MTA and its different subway lines are perceived.
<br><br>
Explore how subway use patterns, average ride lengths, and the most commonly used lines differ across boroughs, along with borough-level views on affordability, satisfaction, and potential fare increases. Together, these comparisons help illustrate how rider attitudes and travel behaviors vary across the city.

## Who are the critics?

```{r, fig.cap="First, we want to understand the survey respondents by borough. Brooklyn and Manhattan had the greatest number of survey respondents, then followed by Queens. This is important to consider as it potentially biases the results seen in this borough analysis, but we tried to compensate for this issue using proportion-based analyses rather than straight counts."}
#Location distribution 
borough_df <- rider_data_full %>% 
  count(borough)

plot_ly(
  borough_df,
  x = ~borough,
  y = ~n,
  type = "bar",
  hovertemplate = "Borough: %{x}<br>Count: %{y}<extra></extra>"
) %>%
  layout(title = "Survey Respondents by Borough",
         xaxis = list(title = "Borough"),
         yaxis = list(title = "Count"))
```


## What do the people think?

```{r, fig.cap="This section summarizes overall rider satisfaction by borough. Exploratory data analysis highlighted aggregated satisfaction response, and we wanted to further understand how this differs across geographic region and visualize patterns. This heat map echoes what was previously seen with the abundance of dissatisfaction by ridership. Approximately 39% of Queens ridership is not satisfied, similar to 38.1% of Brooklyn ridership and 35.2% of Manhattan ridership. Given that a large portion of these riders are commuting to work, these levels of dissatisfaction are particularly noteworthy. Commuters rely on the subway daily to reach their jobs efficiently and reliably, so negative experiences can have tangible impacts on their work performance, stress levels, and overall perception of the transit system. Performing this at the end of our borough analysis allowed us to keep the other trends in focus while interpreting the results of this analysis."}
# Prep data
satis_df <- rider_data_full %>%
  count(borough, overall_satisfaction) %>%
  group_by(borough) %>%
  mutate(
    prop = n / sum(n),
    hover_text = paste0(
      "Borough: ", borough, "<br>",
      "Opinion: ", overall_satisfaction, "<br>",
      "Count: ", n, "<br>",
      "Proportion: ", scales::percent(prop, accuracy = 0.1)
    )
  ) %>%
  ungroup()

#Convert to wide
heat_matrix <- satis_df %>%
  select(borough, overall_satisfaction, prop) %>%
  pivot_wider(
    names_from = overall_satisfaction,
    values_from = prop
  )

#Convert to wide for the hovering information
hover_matrix <- satis_df %>%
  select(borough, overall_satisfaction, hover_text) %>%
  pivot_wider(
    names_from = overall_satisfaction,
    values_from = hover_text
  )

#Produce plot
plot_ly(
  x = colnames(heat_matrix)[-1],
  y = heat_matrix$borough,
  z = as.matrix(heat_matrix[,-1]),
  text = as.matrix(hover_matrix[,-1]),
  type = "heatmap",
  hoverinfo = "text",
  colorscale = "Viridis") %>%
  layout(
    title = "Overall Satisfaction by Borough",
    xaxis = list(title = "Satisfaction Level"),
    yaxis = list(title = "Borough")
  )

```


## Why are they taking the subway? 
```{r, fig.cap="Overall, work was reported the most often for primary use of subway across all boroughs. This observation makes sense for the obvious commuters, those who live outside of NYC, but this trend remained across this survey's top boroughs of Brooklyn, Manhattan, and Queens. Brooklyn and Long Island had the greatest proportion of subway use for work. Regions outside of NYC listed 'other' as their primary use, which could include tourism activities. Due to the structure of this survey's questions, we do not know the exact other reasons outside of work and school."}
#Primary use of subway 
primary_df <- rider_data_full %>%
  count(borough, primary_use_of_subway) %>%
  group_by(borough) %>%
  mutate(prop = n / sum(n))

plot_ly(
  primary_df,
  x = ~borough,
  y = ~prop,
  color = ~primary_use_of_subway,
  type = "bar",
  hovertemplate = 
    "Borough: %{x}<br>Use: %{customdata}<br>Percent: %{y:.1%}<extra></extra>",
  customdata = ~primary_use_of_subway
) %>%
  layout(
    barmode = "stack",
    title = "Primary Subway Use by Borough (Proportions)",
    yaxis = list(tickformat = ".0%", title = "Proportion")
  )
```

## How long do people stay on the train?

```{r, fig.cap="Medium-length commutes were the most common across all boroughs. Given that work was the primary reason respondents used the subway and that Midtown Manhattan is a major employment hub, this pattern suggests many riders travel moderate distances from their home boroughs into central job centers. This remains true for Brooklyn and Manhattan, which have the greatest proportion for medium-length commutes. The longest commute time of 90+ minutes was most often reported by commuters from Queens.<br><br>We expected to see the New York State respondent pool distributed more evenly across the longer ride‐length categories, especially given that work was identified as the primary reason for subway use. Longer commutes are typically associated with workers traveling from outside the city into core employment areas, so a more balanced or long‐skewed pattern would have aligned with that assumption. However, this expectation was not fully supported by the data. Instead, New York State respondents—much like those from the city’s boroughs—reported the highest frequencies in the medium ride‐length categories. This suggests that even riders traveling from outside the five boroughs may not be journeying as far as anticipated, possibly reflecting shorter regional commutes, park-and-ride behavior, or the presence of work destinations dispersed beyond Midtown Manhattan."}
#Average subway ride length 
ride_df <- rider_data_full %>% count(average_length_subway_ride)

plot_ly(
  ride_df,
  x = ~average_length_subway_ride,
  y = ~n,
  type = "bar",
  hovertemplate = "%{x}<br>Count: %{y}<extra></extra>"
) %>%
  layout(title = "Ride Length Distribution",
         xaxis = list(title = "Ride Length Category"),
         yaxis = list(title = "Count"))

```

## Which subway line is the most used?

```{r, fig.cap="Subway line usage varied greatly at an aggregated level as well as across boroughs. If you hover over each dot at the end of the subway line, you can see its breakdown of total respondents and breakdown of respondent counts by borough. The 1 train was the most reported subway line that was used (N=1174). This was followed by the A line (N=469), but with a pretty significant drop in total counts. Both the 1 and A line had the greatest reports from Manhattan, at N=614 and N=295, respectively."}

#Most used line 
line_df <- rider_data_full %>% 
  count(subway_line_used_most_often)

plot_ly() %>%
  add_segments(
    data = line_df,
    x = 0,
    xend = ~n,
    y = ~reorder(subway_line_used_most_often, n),
    yend = ~reorder(subway_line_used_most_often, n),
    hoverinfo = "none"
  ) %>%
  add_markers(
    data = line_df,
    x = ~n,
    y = ~reorder(subway_line_used_most_often, n),
    hovertemplate = "Line: %{y}<br>Count: %{x}<extra></extra>"
  ) %>%
  layout(
    title = "Most Used Subway Lines",
    xaxis = list(title = "Count"),
    yaxis = list(title = "Line")
  )


```

## Do people think the subway is affordable?

```{r, fig.cap="Slightly less than half of respondents in each borough consider the subway to be affordable. Interestingly, riders from outside New York reported the highest perception of affordability compared with any of the city’s boroughs, suggesting that those traveling in from surrounding regions may view subway costs more favorably relative to their usual public transportation options in the U.S., which are likely not as expansive as the MTA system. The Bronx (47.7%%) and New York State (50%) had the smallest proportion of affordability perception relative to other boroughs. When considering the fact that many of these riders are work commuters, this higher perception of affordability may reflect the value they place on the subway as a cost-effective option with their transportation needs."}

#Perception of affordability 
afford_df <- rider_data_full %>%
  count(borough, is_subway_affordable) %>%
  group_by(borough) %>%
  mutate(prop = n / sum(n))

plot_ly(
  afford_df,
  x = ~borough,
  y = ~prop,
  color = ~is_subway_affordable,
  type = "bar",
  hovertemplate = 
    "Borough: %{x}<br>Affordability: %{customdata}<br>Percent: %{y:.1%}<extra></extra>",
  customdata = ~is_subway_affordable
) %>%
  layout(
    barmode = "stack",
    title = "Affordability Perception by Borough",
    yaxis = list(tickformat = ".0%", title = "Proportion")
  )

```

## Is it fair to increase fares?

```{r, fig.cap="This heat map illustrates the distribution of negative, neutral, and positive opinions regarding potential subway fare increases. There was insufficient data from the regions outside of NY and Long Island which led to gaps in the heat map.<br><br>Surprisingly, a majority of respondents expressed positive opinions about the possibility of higher fares, suggesting that many riders may recognize the value of investing in the system or perceive the benefits of fare adjustments as outweighing the costs. Queens and New Jersey respondents had the highest proportion of positive opinions on increased fares, at 62.6% and 65.8%, respectively. The Bronx, Long Island, and Staten Island had the highest proportion of negative opinions at 29.5%, 27.3%, and 22.2% respectively. There was a portion of respondents who either had no opinion or was unaware of the issue.<br><br>It's important to note that despite these reports of positive opinions on increased fares, the overall satisfaction of MTA ridership is quite poor, recall that about 60% of riders are unsatisfied with their MTA experience. Though there is not qualitative data to confirm this, we suspect that respondents may believe increased fares could lead to improved services, potentially solving the poor satisfaction they have for the overall MTA system."}
#Opinion on increased fair 
satis_df <- rider_data_full %>%
  count(borough, opinion_on_increased_fares) %>%
  group_by(borough) %>%
  mutate(
    prop = n / sum(n),
    percent_label = paste0(round(prop * 100, 1), "%")
  ) %>%
  ungroup()

library(plotly)

boroughs <- unique(satis_df$borough)
plot <- plot_ly()

for (i in seq_along(boroughs)) {
  
  b <- boroughs[i]
  df_b <- filter(satis_df, borough == b)
  
  plot <- add_trace(
    plot,
    data = df_b,
    labels = ~opinion_on_increased_fares,
    values = ~prop,
    type = "pie",
    hole = 0.2 + (i - 1) * 0.15,
    textinfo = "none",
    hovertemplate = paste(
      "<b>Borough:</b> ", b, "<br>",
      "<b>Opinion:</b> %{label}<br>",
      "<b>Percent:</b> %{customdata}<extra></extra>"
    ),
    customdata = ~percent_label,
    showlegend = (i == 1)
  )
}

plot <- layout(
  plot,
  title = "Opinion on Increased Fares (Multi-Ring Donut)",
  margin = list(l=20, r=20, t=60, b=20)
)

plot
```


## Check out the Top Complaints:

```{r,fig.width=9, fig.height=6, fig.cap=" As we can see, delays and overcrowded trains dominate in every borough, with Brooklyn and Manhattan reporting the highest volumes overall. Meanwhile, issues like crime/safety and old trains appear less frequently but still show notable variation across boroughs."}
#  Chart D - Summary of top complaints by Borough

valid_boroughs <- c("Manhattan", "Brooklyn", "Queens", "Bronx", "Staten Island")

# Create cleaned dataset
rider_data_full_clean <- rider_data_full %>%
  mutate(
    borough = case_when(
      borough %in% valid_boroughs ~ borough,
      TRUE ~ NA_character_
    )
  )

top_complaints_borough <- rider_data_full_clean |>
  filter(!is.na(borough), !is.na(complaint)) |>
  count(borough, complaint) |>
  group_by(borough) |>
  arrange(desc(n), .by_group = TRUE) |>
  slice_head(n = 10) |>
  ungroup()

plot_top_borough <- top_complaints_borough |> 
  plot_ly(
    x = ~n,
    y = ~fct_reorder(complaint, n),
    color = ~borough,
    type = "bar",
    orientation = "h",
    hovertemplate = paste(
      "Borough: %{data.name}<br>",
      "Complaint: %{y}<br>",
      "Count: %{x}<br>",
      "<extra></extra>"
    ),
    colors = viridis::viridis_pal()(length(unique(top_complaints_borough$borough)))
  ) |> 
  layout(
    title = "Top Complaint Types by Borough",
    xaxis = list(title = "Number of Complaints"),
    yaxis = list(title = "Complaint Type"),
    barmode = "group"
  )

plot_top_borough

```


















