---
title: "Borough Demographics Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: flatly
---

By borough / zip code (like the TA’s example) 
Primary use of subway 
Average subway ride length 
Most used line 

Perception of affordability 
Opinion on increased fair 
Satisfaction 

Converting zip codes into boroughs. I used https://www.nyc.gov/assets/planning/download/office/data-maps/nyc-population/census2000/sf1p11.xls to get majority of the borough's zip codes. Any remaining ones, I looked up on Google. There were three zip codes that I could not find a match for, and were likely miswritten, so I removed those data rows. 


```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(dplyr)
library(viridis)
```


```{r}
#Clean data
subway_rider_data = 
  read_csv("data/2019_subway_rider_data.csv") |> 
  janitor::clean_names()


subway_drops =
  subway_rider_data |> 
  select(-survey_stop_borough, -survey_stop_location) |> 
  drop_na() |> 
  mutate(survey_id = row_number()) |> 
  relocate(survey_id, .before = 1)
  
rider_data =
  subway_drops |>
  mutate(
    use_of_subway_frequency = case_when(
      use_of_subway_frequency == "Everyday / Almost everyday" ~ "Every day",
      use_of_subway_frequency == "More than once a week, varies" ~ "Several times a week",
      use_of_subway_frequency %in% c("Weekdays, Mon - Fri", "~5 days per week") ~ "5 days per week",
      use_of_subway_frequency == "Once a week" ~ "Once a week",
      use_of_subway_frequency == "Once a month" ~ "Once a month",
      use_of_subway_frequency == "Almost never" ~ "Almost never",
      use_of_subway_frequency == "Never" ~ "Never",
      TRUE ~ NA_character_
    ),
    use_of_subway_frequency = 
      factor(
        use_of_subway_frequency,
        levels = c("Never", 
                   "Almost never", 
                   "Once a month", 
                   "Once a week",
                   "Several times a week", 
                   "5 days per week", 
                   "Every day"),
        ordered = TRUE)
    )


rider_data =
  subway_drops |> 
  mutate(average_length_subway_ride = 
           factor(average_length_subway_ride,
                  levels = c("< 20 min", 
                             "20 - 40 min", 
                             "40 - 60 min",
                             "60 - 90 min", 
                             "90 min - 2 hours"),
                  ordered = TRUE))


rider_data =
  subway_drops |>
  mutate(
    overall_satisfaction = 
      recode(
        overall_satisfaction,
        "Not satisfied" = "Unsatisfied"),
    overall_satisfaction = 
      factor(
        overall_satisfaction,
        levels = c("Highly unsatisfied",
                 "Unsatisfied",
                 "Neutral",
                 "Somewhat satisfied",
                 "Very satisfied"),
      ordered = TRUE)
    )


rider_data =
  subway_drops |> 
  mutate(
    frequency_of_delays = factor(
      frequency_of_delays,
      levels = c("Everyday",
                 "A few times a week",
                 "Rarely",
                 "Almost never",
                 "Never"),
      ordered = TRUE)
    )
    
#Zip code --> borough 

zip_code_data = 
  read_csv("data/nyc_zipcodes.csv") %>%
  select(borough, zipcode)

#Make sure character type
rider_data <- rider_data %>%
  mutate(zip_code = as.character(zip_code))
zip_code_data <- zip_code_data %>%
  mutate(zipcode = as.character(zipcode))

#Join
rider_data_full <- rider_data %>%
  left_join(zip_code_data, by = c("zip_code" = "zipcode"))

#If there's no match, we want to keep the zip_code in the borough column, so we use coalesce to handle this
rider_data_full <- rider_data_full %>%
  mutate(borough = coalesce(borough, as.character(zip_code)))

#manually go through remaining zip codes - removing 11135 11290 12105 as they are not real zip codes & also removing one observation that didn't have zip code 
rider_data_full <- rider_data_full %>%
  filter(survey_id != 2410) %>% 
  filter(survey_id != 944) %>% 
  filter(survey_id != 241) %>% 
  filter(survey_id != 919) 
```


### Survey Respondents by Borough
```{r, fig.height=14}
#Location distribution 
borough_df <- rider_data_full %>% 
  count(borough)

#Pick blue from gradient 
viridis_blue <- viridis(100)[40]

#Produce plot
plot_ly(
  borough_df,
  x = ~borough,
  y = ~n,
  type = "bar",
  marker = list(color = viridis_blue),
  hovertemplate = "Borough: %{x}<br>Count: %{y}<extra></extra>"
) %>%
  layout(
    title = "Survey Respondents by Borough",
    xaxis = list(title = "Borough"),
    yaxis = list(title = "Count"),
    autosize = TRUE
  )
```


### Primary Subway Use by Borough
```{r, fig.height=14}
#Primary use of subway 
primary_df <- rider_data_full %>%
  count(borough, primary_use_of_subway) %>%
  group_by(borough) %>%
  mutate(prop = n / sum(n))

#Set colors for the categorical variable 
uses <- unique(primary_df$primary_use_of_subway)
vir_cols <- viridis(length(uses))
names(vir_cols) <- uses

plot_ly(
  primary_df,
  x = ~borough,
  y = ~prop,
  color = ~primary_use_of_subway,
  type = "bar",
  colors = vir_cols,
  hovertemplate =
    "Borough: %{x}<br>Use: %{customdata}<br>Percent: %{y:.1%}<extra></extra>",
  customdata = ~primary_use_of_subway
) %>%
  layout(
    barmode = "stack",
    title = "Primary Subway Use by Borough",
    yaxis = list(tickformat = ".0%", title = "Proportion")
  ) %>%
  layout(autosize = TRUE)
```



### Ride Length Distribution by Borough
```{r, fig.height=14}
#Average subway ride length 
ride_df <- rider_data_full %>%
  count(borough, average_length_subway_ride)

#Set colors for the categorical variable 
boroughs <- unique(ride_df$borough)
vir_cols <- viridis(length(boroughs)) #one color for each borough
names(vir_cols) <- boroughs  

#Produce plot
plot_ly(
  ride_df,
  x = ~average_length_subway_ride,
  y = ~n,
  color = ~borough,
  type = "bar",
  colors = vir_cols,
  text = ~borough, #adding so the borough name will populate in the hover text
  textposition = "none", #hide the label from printing onto the bar plot 
  hovertemplate = "Borough: %{text}<br>Ride Length: %{x}<br>Count: %{y}<extra></extra>"
) %>%
  layout(
    barmode = "stack",
    title = "Ride Length Distribution by Borough",
    xaxis = list(title = "Ride Length Category"),
    yaxis = list(title = "Count")
  )
```


### Most Used Subway Lines by Borough
```{r, fig.height=14}
#Most used line 
line_df <- rider_data_full %>%
  count(borough, subway_line_used_most_often)

#Make the hover show counts per borough
hover_df <- line_df %>%
  group_by(subway_line_used_most_often) %>%
  summarise(
    total_count = sum(n),
    borough_info = paste0(borough, ": ", n, collapse = "<br>")
  )

#Add colors for each subway line 
line_colors <- tibble::tribble(
  ~subway_line, ~color,
  "1", "#EE352E",
  "2", "#EE352E",
  "3", "#EE352E",
  "4", "#00933C",
  "5", "#00933C",
  "6", "#00933C",
  "7", "#B933AD",
  "A", "#0039A6",
  "C", "#0039A6",
  "E", "#0039A6",
  "B", "#FF6319",
  "D", "#FF6319",
  "F", "#FF6319",
  "M", "#FF6319",
  "N", "#FCCC0A",
  "Q", "#FCCC0A",
  "R", "#FCCC0A",
  "W", "#FCCC0A",
  "G", "#6CBE45",
  "J", "#996633",
  "Z", "#996633",
  "L", "#A7A9AC",
  "S", "#808183"
)
hover_df <- hover_df %>%
  left_join(line_colors, by = c("subway_line_used_most_often" = "subway_line"))


#Produce plot
plot_ly(hover_df) %>%
  add_segments(
    x = 0,
    xend = ~total_count,
    y = ~reorder(subway_line_used_most_often, total_count),
    yend = ~reorder(subway_line_used_most_often, total_count),
    line = list(color = ~color),
    hoverinfo = "none",
    showlegend = FALSE 
  ) %>%
  add_markers(
    x = ~total_count,
    y = ~reorder(subway_line_used_most_often, total_count),
    marker = list(color = ~color),
    hovertemplate = "Line: %{y}<br>Total Count: %{x}<br>%{customdata}<extra></extra>",
    customdata = ~borough_info,
    showlegend = FALSE
  ) %>%
  layout(
    title = "Most Used Subway Lines by Borough",
    xaxis = list(title = "Count"),
    yaxis = list(title = "Subway Line")
  )

```


### Affordability Perception by Borough
```{r, fig.height=14}
#Initialize to see unique TRUE/FALSE values 
vals <- unique(afford_df$is_subway_affordable)

#Make colors for each categorical option
vals <- unique(afford_df$is_subway_affordable)
vir_cols <- viridis(length(vals))     
names(vir_cols) <- vals                        

#Produce plot
plot_ly(
  afford_df,
  x = ~borough,
  y = ~prop,
  color = ~is_subway_affordable,
  type = "bar",
  colors = vir_cols,                         
  customdata = ~is_subway_affordable,
  hovertemplate = "Borough: %{x}<br>Affordability: %{customdata}<br>Percent: %{y:.1%}<extra></extra>"
) %>%
  layout(
    barmode = "stack",
    title = "Affordability Perception by Borough",
    yaxis = list(tickformat = ".0%", title = "Proportion")
  )

```


### Opinions on Increased Fairs by Borough
```{r, fig.height=14}
#Opinion on increased fair 
opinion_df <- rider_data_full %>%
  count(borough, opinion_on_increased_fares) %>%
  group_by(borough) %>%
  mutate(
    prop = n / sum(n),
    hover_text = paste0(
      "Borough: ", borough, "<br>",
      "Opinion: ", opinion_on_increased_fares, "<br>",
      "Count: ", n, "<br>",
      "Proportion: ", scales::percent(prop, accuracy = 0.1)
    )
  ) %>%
  ungroup()

#Convert to wide
heat_matrix <- opinion_df %>%
  select(borough, opinion_on_increased_fares, prop) %>%
  pivot_wider(
    names_from = opinion_on_increased_fares,
    values_from = prop
  )

#Convert to wide for the hovering information
hover_matrix <- opinion_df %>%
  select(borough, opinion_on_increased_fares, hover_text) %>%
  pivot_wider(
    names_from = opinion_on_increased_fares,
    values_from = hover_text
  )

#Produce plot
plot_ly(
  x = colnames(heat_matrix)[-1],
  y = heat_matrix$borough,
  z = as.matrix(heat_matrix[,-1]),
  text = as.matrix(hover_matrix[,-1]),
  type = "heatmap",
  hoverinfo = "text",
  colorscale = "Viridis") %>%
  layout(
    title = "Opinions on Increased Fares by Borough",
    xaxis = list(title = "Opinion"),
    yaxis = list(title = "Borough")
  )

```

### Aggregated Satisfaction Levels 
```{r, fig.height=14}
#Satisfaction 
satis_overall <- rider_data_full %>%
  count(overall_satisfaction) %>%
  mutate(prop = n / sum(n),
         percent = paste0(round(prop*100,1), "%"))

#Set colors to gradient manually 
viridis_colors <- viridis(nrow(satis_overall))

plot_ly(
  satis_overall,
  labels = ~overall_satisfaction,
  values = ~prop,
  type = "pie",
  hole = .5,
  textinfo = "label+percent",
  marker = list(colors = viridis_colors),   # ← APPLY VIRIDIS HERE
  hovertemplate = "%{label}<br>%{percent}<extra></extra>"
) %>%
  layout(title = "Aggregated Satisfaction Levels")
```


### Satisfaction Levels by Borough
```{r}
# Prep data
satis_df <- rider_data_full %>%
  count(borough, overall_satisfaction) %>%
  group_by(borough) %>%
  mutate(
    prop = n / sum(n),
    hover_text = paste0(
      "Borough: ", borough, "<br>",
      "Opinion: ", overall_satisfaction, "<br>",
      "Count: ", n, "<br>",
      "Proportion: ", scales::percent(prop, accuracy = 0.1)
    )
  ) %>%
  ungroup()

#Convert to wide
heat_matrix <- satis_df %>%
  select(borough, overall_satisfaction, prop) %>%
  pivot_wider(
    names_from = overall_satisfaction,
    values_from = prop
  )

#Convert to wide for the hovering information
hover_matrix <- satis_df %>%
  select(borough, overall_satisfaction, hover_text) %>%
  pivot_wider(
    names_from = overall_satisfaction,
    values_from = hover_text
  )

#Produce plot
plot_ly(
  x = colnames(heat_matrix)[-1],
  y = heat_matrix$borough,
  z = as.matrix(heat_matrix[,-1]),
  text = as.matrix(hover_matrix[,-1]),
  type = "heatmap",
  hoverinfo = "text",
  colorscale = "Viridis") %>%
  layout(
    title = "Overall Satisfaction by Borough",
    xaxis = list(title = "Satisfaction Level"),
    yaxis = list(title = "Borough")
  )

```

