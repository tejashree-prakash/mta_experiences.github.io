---
title: "Frequency of Delays by Subway Line"
---

This is an interactive visualization representing the frequency of delays by subway line.

Packages (need to install gt package to use gt library first)
```{r}
library(tidyverse)
library(janitor)
library(viridis)
library(plotly)
library(knitr)
library(gt)
```

Load data.
```{r}
raw <- read_csv("data/2019_subway_rider_data.csv") |> 
  clean_names()
```

Clean dataset.
```{r}
# split multi-line answers (e.g., "A/C" → "A", "C")
cleaned <- raw |> 
  mutate(
    subway_line = subway_line_used_most_often |> 
      str_replace_all("[^A-Za-z0-9]", "/") |>   # normalize separators
      str_split("/")                            # split into multiple lines
  ) |> 
  unnest(subway_line) |> 
  mutate(
    subway_line = str_trim(subway_line),
    subway_line = str_to_upper(subway_line)
  ) |> 
  filter(subway_line %in% c(
    "1","2","3","4","5","6","7",
    "A","B","C","D","E","F","M",
    "G","J","Z","N","Q","R","W","L","S"
  ))

# Convert column naming to an ordered factor for plotting:
cleaned <- cleaned |> 
  mutate(
    frequency_of_delays = factor(
      frequency_of_delays,
      levels = c(
        "Never",
        "Rarely",
        "Once a month",
        "A few times a month",
        "A few times a week",
        "Everyday"
      ),
      ordered = TRUE
    )
  )

#convert to a numeric midpoint in minutes (for average delay per line):
cleaned <- cleaned |> 
  mutate(
    delay_min = case_when(
      approximate_delay_duration == "< 10 min" ~ 5,
      approximate_delay_duration == "10 - 20 min" ~ 15,
      approximate_delay_duration == "20 - 40 min" ~ 30,
      approximate_delay_duration == "40 - 60 min" ~ 50,
      approximate_delay_duration == "Over 60 min" ~ 70,
      approximate_delay_duration == "Over 40 min" ~ 50,
      TRUE ~ NA_real_
    )
  )
```

### 1. Subway Line Directory:
```{r}
subway_directory_display <- tribble(
  ~`Line Family`, ~Lines, ~Color,
  "Red Line", "1, 2, 3", "#EE352E",
  "Green Line", "4, 5, 6", "#00933C",
  "Purple Line", "7", "#B933AD",
  "Blue Line", "A, C, E", "#0039A6",
  "Orange Line", "B, D, F, M", "#FF6319",
  "Yellow Line", "N, Q, R, W", "#FCCC0A",
  "Light Green Line", "G", "#6CBE45",
  "Brown Line", "J, Z", "#996633",
  "Gray Line", "L", "#A7A9AC",
  "Shuttle", "S", "#808183"
)

subway_directory_display |>
  gt() |>
  tab_header(
    title = "NYC Subway Line Directory"
  ) |>
  text_transform(
    locations = cells_body(columns = Color),
    fn = function(color) {
      paste0(
        "<div style='background-color:", color,
        "; width: 60px; height: 20px; border-radius: 4px'></div>"
      )
    }
  ) |>
  cols_width(
    everything() ~ px(180)
  ) |>
  opt_table_outline()
```


Join-ready Subway Line Directory for analysis:
```{r}
subway_directory <- tribble(
  ~subway_line, ~group_color, ~hex_color,
  "1","Red Line","#EE352E",
  "2","Red Line","#EE352E",
  "3","Red Line","#EE352E",
  "4","Green Line","#00933C",
  "5","Green Line","#00933C",
  "6","Green Line","#00933C",
  "7","Purple Line","#B933AD",
  "A","Blue Line","#0039A6",
  "C","Blue Line","#0039A6",
  "E","Blue Line","#0039A6",
  "B","Orange Line","#FF6319",
  "D","Orange Line","#FF6319",
  "F","Orange Line","#FF6319",
  "M","Orange Line","#FF6319",
  "N","Yellow Line","#FCCC0A",
  "Q","Yellow Line","#FCCC0A",
  "R","Yellow Line","#FCCC0A",
  "W","Yellow Line","#FCCC0A",
  "G","Light Green Line","#6CBE45",
  "J","Brown Line","#996633",
  "Z","Brown Line","#996633",
  "L","Gray Line","#A7A9AC",
  "S","Shuttle","#808183"
)

cleaned <- cleaned |> 
  left_join(subway_directory, by = "subway_line")
```

### 2. Distribution of Delay Frequency Responses by Subway Line 
Interactive Plotly Stacked Bar Chart 
```{r}
# Build distribution dataset
dist_delay <- cleaned |>
  filter(!is.na(frequency_of_delays)) |>
  count(subway_line, frequency_of_delays) |>
  group_by(subway_line) |>
  mutate(prop = n / sum(n)) |>
  ungroup() |>
  left_join(subway_directory, by="subway_line") |>
  arrange(group_color, subway_line) |>
  mutate(subway_line = factor(subway_line, levels = unique(subway_line)))

# Plot
plot_ly(
  data = dist_delay,
  x = ~subway_line,
  y = ~prop,
  type = "bar",
  color = ~frequency_of_delays,
  colors = viridisLite::viridis(6),
  customdata = ~frequency_of_delays,
  hovertemplate = paste(
    "<b>Subway Line:</b> %{x}<br>",
    "<b>Delay Frequency:</b> %{customdata}<br>",
    "<b>Proportion of Riders:</b> %{y:.1%}<br>",
    "<extra></extra>"
  )
) |>
  layout(
    barmode = "stack",
    title = list(
      text = "<b>Distribution of Delay Frequency Responses by Subway Line</b>",
      x = 0.5
    ),
    xaxis = list(title = "Subway Line"),
    yaxis = list(title = "Proportion", tickformat=".0%"),
    showlegend = TRUE
  )
```


### 3. Proportion of Riders Reporting Long Delays (≥20 min) by individual line
Interactive plotly bar chart
```{r}
# Define long-delay categories
long_categories <- c( 
  "20 - 40 min", "20 - 45 min",
  "40 - 60 min", "45 - 60 min",
  "> 60 min"
)

# Create an ordering by line family
line_order <- subway_directory |> 
  arrange(group_color, subway_line) |> 
  pull(subway_line)

# Build long delay dataset
long_delay_by_line <- cleaned |> 
  filter(!is.na(approximate_delay_duration)) |> 
  mutate(
    long_delay = approximate_delay_duration %in% long_categories
  ) |> 
  count(subway_line, long_delay) |> 
  group_by(subway_line) |> 
  mutate(prop = n / sum(n)) |> 
  filter(long_delay == TRUE) |> 
  select(subway_line, prop) |> 
  left_join(subway_directory, by = "subway_line") |> 
  mutate(
    subway_line = factor(subway_line, levels = line_order),
    group_color = factor(group_color, levels = unique(subway_directory$group_color))
  )

# Now plot
plot_ly(
  data = long_delay_by_line,
  x = ~subway_line,
  y = ~prop,
  type = "bar",
  marker = list(color = ~hex_color),
  customdata = ~group_color,
  hovertemplate = paste(
    "<b>Subway Line:</b> %{x}<br>",
    "<b>Proportion Long Delays (≥20 min):</b> %{y:.2f}<br>",
    "<b>Color Group:</b> %{customdata}",
    "<extra></extra>"
  )
) |>
  layout(
    title = list(
      text = "Proportion of Riders Reporting Long Delays (≥ 20 min)",
      y = 0.95
    ),
    xaxis = list(
      title = "Subway Line",
      tickangle = 0,
      categoryorder = "array",
      categoryarray = line_order
    ),
    yaxis = list(
      title = "Proportion of Long Delays",
      tickformat = ".0%",
      range = c(0, max(long_delay_by_line$prop) * 1.1)
    ),
    bargap = 0.20,     # spacing between groups
    bargroupgap = 0.05 # spacing within groups
  )
```

### 4. Ordinal frequency of delay responses
Interactive plotly heat map
```{r}
# keep only the meaningful delay levels
keep_delays <- c(
  "Rarely",
  "A few times a week",
  "Everyday"
)

heat_data <- cleaned |> 
  filter(!is.na(frequency_of_delays)) |> 
  filter(frequency_of_delays %in% keep_delays) |> 
  count(subway_line, frequency_of_delays) |> 
  tidyr::complete(
    subway_line = unique(subway_directory$subway_line),
    frequency_of_delays = keep_delays,
    fill = list(n = 0)
  ) |>
  group_by(subway_line) |> 
  mutate(prop = n / sum(n)) |> 
  ungroup() |> 
  left_join(subway_directory, by = "subway_line") |> 
  arrange(group_color, subway_line) |> 
  mutate(
    subway_line = factor(subway_line, levels = unique(subway_line)),
    frequency_of_delays = factor(frequency_of_delays, levels = keep_delays)
  )

# Heatmap (now only 3 categories)
plot_ly(
  data = heat_data,
  x = ~frequency_of_delays,
  y = ~subway_line,
  z = ~prop,
  type = "heatmap",
  colors = viridisLite::viridis(100),
  customdata = ~n,
  hovertemplate = paste(
    "<b>Line:</b> %{y}<br>",
    "<b>Delay Frequency:</b> %{x}<br>",
    "<b>Proportion:</b> %{z:.1%}<br>",
    "<b>Count:</b> %{customdata}<br>",
    "<extra></extra>"
  )
) |>
  layout(
    title = "Delay Frequency Distribution by Subway Line",
    xaxis = list(
      title = "Delay Frequency",
      tickangle = 0,
      categoryorder = "array",
      categoryarray = keep_delays
    ),
    yaxis = list(
      title = "Subway Line",
      categoryorder = "array",
      categoryarray = unique(heat_data$subway_line)
    ),
    margin = list(l = 90, r = 20, b = 80, t = 80),
    paper_bgcolor = "white",
    plot_bgcolor = "white"
  )
```

