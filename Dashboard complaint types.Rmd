---
title: "Subway Complaint Analysis Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: flatly
---
Importing the cleaned dataset 
```{r setup, include=TRUE}

library(flexdashboard)
library(tidyverse)
library(lubridate)
library(plotly)
library(viridis)
library(readxl)
library(treemapify)
```


```{r}
subway_rider_data = 
  read_csv("2019_Subway_Rider_Survey_20251121.csv") |> 
  janitor::clean_names()


subway_drops =
  subway_rider_data |> 
  select(-survey_stop_borough, -survey_stop_location) |> 
  drop_na() |> 
  mutate(survey_id = row_number()) |> 
  relocate(survey_id, .before = 1)
  
```


```{r}
rider_data =
  subway_drops |>
  mutate(
    use_of_subway_frequency = case_when(
      use_of_subway_frequency == "Everyday / Almost everyday" ~ "Every day",
      use_of_subway_frequency == "More than once a week, varies" ~ "Several times a week",
      use_of_subway_frequency %in% c("Weekdays, Mon - Fri", "~5 days per week") ~ "5 days per week",
      use_of_subway_frequency == "Once a week" ~ "Once a week",
      use_of_subway_frequency == "Once a month" ~ "Once a month",
      use_of_subway_frequency == "Almost never" ~ "Almost never",
      use_of_subway_frequency == "Never" ~ "Never",
      TRUE ~ NA_character_
    ),
    use_of_subway_frequency = 
      factor(
        use_of_subway_frequency,
        levels = c("Never", 
                   "Almost never", 
                   "Once a month", 
                   "Once a week",
                   "Several times a week", 
                   "5 days per week", 
                   "Every day"),
        ordered = TRUE)
    )


rider_data =
  subway_drops |> 
  mutate(average_length_subway_ride = 
           factor(average_length_subway_ride,
                  levels = c("< 20 min", 
                             "20 - 40 min", 
                             "40 - 60 min",
                             "60 - 90 min", 
                             "90 min - 2 hours"),
                  ordered = TRUE))


rider_data =
  subway_drops |>
  mutate(
    overall_satisfaction = 
      recode(
        overall_satisfaction,
        "Not satisfied" = "Unsatisfied"),
    overall_satisfaction = 
      factor(
        overall_satisfaction,
        levels = c("Highly unsatisfied",
                 "Unsatisfied",
                 "Neutral",
                 "Somewhat satisfied",
                 "Very satisfied"),
      ordered = TRUE)
    )


rider_data =
  subway_drops |> 
  mutate(
    frequency_of_delays = factor(
      frequency_of_delays,
      levels = c("Everyday",
                 "A few times a week",
                 "Rarely",
                 "Almost never",
                 "Never"),
      ordered = TRUE)
    )
    
```


```{r}
rider_data =
  rider_data |> 
  mutate(
    top_three_complaints = 
      str_remove_all(top_three_complaints, "\\[|\\]|'")
  ) |> 
  separate_rows(top_three_complaints, sep = ",") |> 
  mutate(top_three_complaints = 
           str_trim(top_three_complaints)) |> 
  rename(complaint = top_three_complaints)
```

```{r}
rider_data = 
  rider_data |> 
  mutate(
    is_subway_affordable = if_else(
      is_subway_affordable == "Yes", TRUE, FALSE),
    zip_code = as.character(zip_code)
    )


rider_data =
  rider_data |> 
  mutate(
    across(c(subway_line_used_most_often,
             get_to_subway_via,
             primary_use_of_subway,
             alternative_transport), as.factor)
  )
```


```{r}
zip_raw <- read_excel("nyc_zipcodes.xls", skip = 4)

# Step 2: Rename columns properly
colnames(zip_raw) <- c(
  "borough", "zipcode", "total_population", "white", "black_or_african_american",
  "american_indian_alaska_native", "asian", "native_hawaiian_other_pacific",
  "some_other_race", "two_or_more_races", "hispanic_origin", "total_housing_units"
)

# Step 3: Now select only borough and zipcode
zip_code_data <- zip_raw %>%
  select(borough, zipcode) %>%
  mutate(zipcode = as.character(zipcode))  # ensure character

# Step 4: Make rider_data zip_code a character
rider_data <- rider_data %>%
  mutate(zip_code = as.character(zip_code))

# Step 5: Join
rider_data_full <- rider_data %>%
  left_join(zip_code_data, by = c("zip_code" = "zipcode"))

# Step 6: Fill borough where missing
rider_data_full <- rider_data_full %>%
  mutate(borough = coalesce(borough, as.character(zip_code)))

# Step 7: Remove invalid zip codes
rider_data_full <- rider_data_full %>%
  filter(!zip_code %in% c("12105", "11290", "11135"))

```

```{r}
complaint_data_time <- rider_data_full |> 
  mutate(
    submitted_at = mdy_hm(submitted_at),
    hour = hour(submitted_at),
    time_of_day = case_when(
      hour >= 6 & hour < 12 ~ "Morning",
      hour >= 12 & hour < 17 ~ "Afternoon", 
      hour >= 17 & hour < 21 ~ "Evening",
      TRUE ~ "Night"
    ),
    time_of_day = factor(time_of_day, 
                        levels = c("Morning", "Afternoon", "Evening", "Night"))
  )
```

Column {data-width=1800}
-----------------------------------------------------------------------

### Chart A

```{r, fig.width=15, fig.height=8}
### Complaint types by time and line overall 

# Create summary data for the main plot
complaint_summary =
  complaint_data_time |> 
  count(subway_line_used_most_often, time_of_day, complaint) |> 
  group_by(subway_line_used_most_often, time_of_day) |> 
  mutate(percent = n / sum(n) * 100) |> 
  ungroup()

# Create interactive plot using plot_ly (following class examples)
main_plot <- complaint_summary |> 
  mutate(
    text_label = str_c(
      "Line: ", subway_line_used_most_often,
      "\nTime: ", time_of_day, 
      "\nComplaint: ", complaint,
      "\nCount: ", n,
      "\nPercent: ", round(percent, 1), "%"
    )
  ) |> 
  plot_ly(
    x = ~time_of_day, 
    y = ~n, 
    color = ~complaint,
    type = "bar",
    text = ~text_label,
    hoverinfo = "text",
    colors = viridis::viridis_pal()(length(unique(complaint_summary$complaint)))
  ) |> 
  layout(
    barmode = "stack",
    title = "Complaint Types by Time of Day and Subway Line",
    xaxis = list(title = "Time of Day"),
    yaxis = list(title = "Number of Complaints"),
    showlegend = TRUE
  )

main_plot
```


Column {data-width=1800}
-----------------------------------------------------------------------

### Chart B

```{r, fig.width=15, fig.height=8}

# Summary of top complaints overall

top_complaints <- complaint_data_time |> 
  count(complaint) |> 
  arrange(desc(n)) |> 
  head(10)

bar_plot <- top_complaints |> 
  mutate(
    text_label = str_c("Complaint: ", complaint, "\nCount: ", n)
  ) |> 
  plot_ly(
    x = ~n,
    y = ~fct_reorder(complaint, n),
    type = "bar",
    orientation = "h",
    text = ~text_label,
    hoverinfo = "text",
    marker = list(color = viridis::viridis_pal()(10))
  ) |> 
  layout(
    title = "Top 10 Complaint Types",
    xaxis = list(title = "Number of Complaints"),
    yaxis = list(title = "")
  )

bar_plot

```



Column {data-width=1800}
-----------------------------------------------------------------------

### Chart C

```{r, fig.width=15, fig.height=8}

# distrubtion of complaint types overall 

complaint_treemap_data <- rider_data_full %>%
  filter(!is.na(subway_line_used_most_often),
         !is.na(complaint)) %>%
  group_by(subway_line_used_most_often, complaint) %>%
  summarize(n = n(), .groups = "drop") %>%
  group_by(subway_line_used_most_often) %>%
  mutate(
    total_line = sum(n),
    percent = n / total_line * 100
  )

treemap_plot <- ggplot(
  complaint_treemap_data,
  aes(
    area = percent,
    fill = complaint,
    label = paste0(complaint, "\n", round(percent,1), "%")
  )
) +
  geom_treemap() +
  geom_treemap_text(
    place = "centre",
    grow = TRUE,
    colour = "white",
    min.size = 4
  ) +
  facet_wrap(~ subway_line_used_most_often) +
  scale_fill_viridis_d(option = "C") +
  labs(
    title = "Distribution of Complaint Types Within Each Subway Line",
    subtitle = "Treemap size represents the percentage of complaint types per subway line",
    fill = "Complaint Type"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face="bold"),
    strip.text = element_text(size = 12, face = "bold")
  )

treemap_plot
```


Column {data-width=1800}
-----------------------------------------------------------------------

### Chart D

```{r,fig.width=15, fig.height=8}
# Summary of top complaints by Borough

valid_boroughs <- c("Manhattan", "Brooklyn", "Queens", "Bronx", "Staten Island")

# Create cleaned dataset
rider_data_full_clean <- rider_data_full %>%
  mutate(
    borough = case_when(
      borough %in% valid_boroughs ~ borough,
      TRUE ~ NA_character_
    )
  )

top_complaints_borough <- rider_data_full_clean |>
  filter(!is.na(borough), !is.na(complaint)) |>
  count(borough, complaint) |>
  group_by(borough) |>
  arrange(desc(n), .by_group = TRUE) |>
  slice_head(n = 10) |>
  ungroup()

plot_top_borough <- top_complaints_borough |> 
  mutate(
    text_label = str_c(
      "Borough: ", borough,
      "\nComplaint: ", complaint,
      "\nCount: ", n
    )
  ) |>
  plot_ly(
    x = ~n,
    y = ~fct_reorder(complaint, n),
    color = ~borough,   # Now only 5 categories
    type = "bar",
    orientation = "h",
    text = ~text_label,
    hoverinfo = "text",
    colors = viridis::viridis_pal()(length(unique(top_complaints_borough$borough)))
  ) |> 
  layout(
    title = "Top Complaint Types by Borough",
    xaxis = list(title = "Number of Complaints"),
    yaxis = list(title = "Complaint Type"),
    barmode = "group"
  )

plot_top_borough
```




Column {data-width=1800}
-----------------------------------------------------------------------

### Chart E

```{r,fig.width=15, fig.height=8}
# Complaint types by line and borough


complaint_line_borough <- rider_data_full_clean |> 
  filter(!is.na(subway_line_used_most_often),
         !is.na(borough),
         !is.na(complaint)) |>
  count(subway_line_used_most_often, borough, complaint) |> 
  group_by(subway_line_used_most_often, borough) |> 
  mutate(percent = n / sum(n) * 100) |> 
  ungroup()

plot_line_borough <- complaint_line_borough |> 
  mutate(
    text_label = str_c(
      "Line: ", subway_line_used_most_often,
      "\nBorough: ", borough,
      "\nComplaint: ", complaint,
      "\nCount: ", n,
      "\nPercent: ", round(percent, 1), "%"
    )
  ) |> 
  plot_ly(
    x = ~borough,
    y = ~percent,
    type = "bar",
    color = ~complaint,
    text = ~text_label,
    hoverinfo = "text",
    colors = viridis::viridis_pal()(length(unique(complaint_line_borough$complaint)))
  ) |> 
  layout(
    barmode = "stack",
    title = "Complaint Types by Subway Line and Borough",
    xaxis = list(title = "Borough"),
    yaxis = list(title = "Percent of Complaints"),
    showlegend = TRUE
  )

plot_line_borough
```





