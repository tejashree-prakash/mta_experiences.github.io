---
title: "Subway Complaint Analysis Dashboard "
---


```{r}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(plotly)
library(viridis)
library(readxl)
library(treemapify)
```

 

```{r}
subway_rider_data = 
  read_csv("data/2019_Subway_Rider_Survey_20251121.csv") |> 
  janitor::clean_names()


subway_drops =
  subway_rider_data |> 
  select(-survey_stop_borough, -survey_stop_location) |> 
  drop_na() |> 
  mutate(survey_id = row_number()) |> 
  relocate(survey_id, .before = 1)
  
```


```{r}
rider_data =
  subway_drops |>
  mutate(
    use_of_subway_frequency = case_when(
      use_of_subway_frequency == "Everyday / Almost everyday" ~ "Every day",
      use_of_subway_frequency == "More than once a week, varies" ~ "Several times a week",
      use_of_subway_frequency %in% c("Weekdays, Mon - Fri", "~5 days per week") ~ "5 days per week",
      use_of_subway_frequency == "Once a week" ~ "Once a week",
      use_of_subway_frequency == "Once a month" ~ "Once a month",
      use_of_subway_frequency == "Almost never" ~ "Almost never",
      use_of_subway_frequency == "Never" ~ "Never",
      TRUE ~ NA_character_
    ),
    use_of_subway_frequency = 
      factor(
        use_of_subway_frequency,
        levels = c("Never", 
                   "Almost never", 
                   "Once a month", 
                   "Once a week",
                   "Several times a week", 
                   "5 days per week", 
                   "Every day"),
        ordered = TRUE)
    )


rider_data =
  subway_drops |> 
  mutate(average_length_subway_ride = 
           factor(average_length_subway_ride,
                  levels = c("< 20 min", 
                             "20 - 40 min", 
                             "40 - 60 min",
                             "60 - 90 min", 
                             "90 min - 2 hours"),
                  ordered = TRUE))


rider_data =
  subway_drops |>
  mutate(
    overall_satisfaction = 
      recode(
        overall_satisfaction,
        "Not satisfied" = "Unsatisfied"),
    overall_satisfaction = 
      factor(
        overall_satisfaction,
        levels = c("Highly unsatisfied",
                 "Unsatisfied",
                 "Neutral",
                 "Somewhat satisfied",
                 "Very satisfied"),
      ordered = TRUE)
    )


rider_data =
  subway_drops |> 
  mutate(
    frequency_of_delays = factor(
      frequency_of_delays,
      levels = c("Everyday",
                 "A few times a week",
                 "Rarely",
                 "Almost never",
                 "Never"),
      ordered = TRUE)
    )
    
```




```{r}
rider_data = 
  rider_data |> 
  mutate(
    is_subway_affordable = if_else(
      is_subway_affordable == "Yes", TRUE, FALSE),
    zip_code = as.character(zip_code)
    )


rider_data =
  rider_data |> 
  mutate(
    across(c(subway_line_used_most_often,
             get_to_subway_via,
             primary_use_of_subway,
             alternative_transport), as.factor)
  )
```


```{r}
rider_data = 
  rider_data %>%
  mutate(
    top_three_complaints = 
      str_remove_all(top_three_complaints, "\\[|\\]|'")
  )
```


```{r}
zip_code_data = 
  read_csv("data/nyc_zipcodes.csv") %>%
  select(borough, zipcode)


#Make sure character variables 
zip_code_data <- zip_code_data %>%
  mutate(zipcode = as.character(zipcode)) #make sure it's a character variable 
rider_data <- rider_data %>%
  mutate(zip_code = as.character(zip_code))

#Join
rider_data_full <- rider_data %>%
  left_join(zip_code_data, by = c("zip_code" = "zipcode"))

#Fill borough where missing
rider_data_full <- rider_data_full %>%
  mutate(borough = coalesce(borough, as.character(zip_code)))

#Remove invalid zip codes
rider_data_full <- rider_data_full %>%
  filter(survey_id != 2410) %>% 
  filter(survey_id != 944) %>% 
  filter(survey_id != 241) %>% 
  filter(survey_id != 919) 
```



```{r}
# I added this ( adding the complaint variable)
rider_data_full <- rider_data_full |>
  mutate(
    complaint = str_split(top_three_complaints, ",\\s*")
  ) |>
  tidyr::unnest(complaint)
```


```{r}
# Creating a complaint_data_time dataset (I added this)
complaint_data_time <- rider_data_full |> 
  mutate(
    submitted_at = mdy_hm(submitted_at),
    hour = hour(submitted_at),
    time_of_day = case_when(
      hour >= 6 & hour < 12 ~ "Morning",  #6 am to 11:59 am
      hour >= 12 & hour < 17 ~ "Afternoon", #12 pm to 4:59 pm
      hour >= 17 & hour < 21 ~ "Evening",  #5pm to 8:59 pm
      TRUE ~ "Night" # 9pm to 5:59 am 
    ),
    time_of_day = factor(time_of_day, 
                        levels = c("Morning", "Afternoon", "Evening", "Night"))
  )
```



## Subway Complaints {.tabset}

### Complaint Percent by Line and Time

**Figure:** This chart provides a detailed breakdown of subway complaints by both the specific transit line and the time of day (morning, afternoon, evening, night).The stacked bar graphs reveal how the distribution of primary complaints (such as delays, overcrowding, and crime) shifts significantly throughout the day, highlighting the distinct challenges during peak versus off-peak hours.The visualization allows for clear comparison across the system, showing which issues are most acute for each line at different times.
```{r, fig.width=15, fig.height=8}


complaint_summary <- complaint_data_time |> 
  count(subway_line_used_most_often, time_of_day, complaint) |> 
  group_by(subway_line_used_most_often, time_of_day) |> 
  mutate(percent = n / sum(n) * 100) |> 
  ungroup()


library(viridis)

all_complaints <- sort(unique(complaint_summary$complaint))
viridis_colors <- viridis(length(all_complaints))
names(viridis_colors) <- all_complaints


times <- unique(complaint_summary$time_of_day)

plot <- plot_ly()
i <- 0

for (t in times) {
  df_t <- complaint_summary |> filter(time_of_day == t)
  
  for (comp in unique(df_t$complaint)) {
    df_tc <- df_t |> filter(complaint == comp)
    
    plot <- plot |> add_trace(
      data = df_tc,
      x = ~percent,
      y = ~subway_line_used_most_often,
      type = "bar",
      orientation = "h",
      name = comp,
      hovertemplate = paste(
        "Time: ", t,
        "<br>Line: %{y}",
        "<br>Complaint: ", comp,
        "<br>Count: %{customdata}",
        "<br>Percent: %{x:.1f}%",
        "<extra></extra>"
      ),
      customdata = ~n,
      marker = list(color = viridis_colors[comp]),
      visible = ifelse(t == times[1], TRUE, FALSE),
      legendgroup = comp
    )
    
    i <- i + 1
  }
}

# Build dropdown buttons
buttons <- list()
for (k in seq_along(times)) {
  vis <- rep(FALSE, length(unique(complaint_summary$complaint)) * length(times))
  
  start <- (k - 1) * length(unique(complaint_summary$complaint)) + 1
  end <- start + length(unique(complaint_summary$complaint)) - 1
  
  vis[start:end] <- TRUE
  
  buttons[[k]] <- list(
    method = "restyle",
    args = list("visible", vis),
    label = times[k]
  )
}

# Final layout with dropdown moved
plot |> layout(
  title = "Complaint Percent by Subway Line and Time of Day",
  xaxis = list(title = "Percent of Complaints"),
  yaxis = list(title = "Subway Line"),
  barmode = "stack",
  # Move legend if needed (optional)
  legend = list(
    x = 1.1,
    y = 0.5
  ),
  updatemenus = list(
    list(
      y = 0.98,        # Move to top right, below title
      x = 0.98,        # Right side
      buttons = buttons,
      type = "dropdown",
      xanchor = "left",  # Anchor to left side
      yanchor = "top"     # Anchor to top
    )
  )
)

```




### Summary of top complaints 


**Figure:**  This graph shows the most common subway complaint types across the five New York City boroughs. Delays (3932) and overcrowded trains (3078) are the most frequently reported issues overall, and less frequent concerns like old trains or crime appear at much lower levels across all boroughs.

```{r, fig.width=15, fig.height=8}

#  Chart B - Summary of top complaints overall

top_complaints <- complaint_data_time |> 
  count(complaint) |> 
  arrange(desc(n)) |> 
  head(10)

bar_plot <- top_complaints |> 
  plot_ly(
    x = ~n,
    y = ~fct_reorder(complaint, n),
    type = "bar",
    orientation = "h",
    text = ~n,  
    textposition = "inside",  
    hoverinfo = "x+y",
    marker = list(color = viridis::viridis_pal()(10))
  ) |> 
  layout(
    title = "Top 10 Complaint Types",
    xaxis = list(title = "Number of Complaints"),
    yaxis = list(title = "")
  )

bar_plot

```


### Summary of top complaints by Borough

**Figure:** This chart compares the most common subway complaints, broken up by the 5  New York City boroughs. As we can see, delays and overcrowded trains dominate in every borough, with Brooklyn and Manhattan reporting the highest volumes overall. Meanwhile, issues like crime/safety and old trains appear less frequently but still show notable variation across boroughs.

```{r, fig.width=15, fig.height=8}
#  Chart D - Summary of top complaints by Borough

valid_boroughs <- c("Manhattan", "Brooklyn", "Queens", "Bronx", "Staten Island")

# Create cleaned dataset
rider_data_full_clean <- rider_data_full %>%
  mutate(
    borough = case_when(
      borough %in% valid_boroughs ~ borough,
      TRUE ~ NA_character_
    )
  )

top_complaints_borough <- rider_data_full_clean |>
  filter(!is.na(borough), !is.na(complaint)) |>
  count(borough, complaint) |>
  group_by(borough) |>
  arrange(desc(n), .by_group = TRUE) |>
  slice_head(n = 10) |>
  ungroup()

plot_top_borough <- top_complaints_borough |> 
  plot_ly(
    x = ~n,
    y = ~fct_reorder(complaint, n),
    color = ~borough,
    type = "bar",
    orientation = "h",
    hovertemplate = paste(
      "Borough: %{data.name}<br>",
      "Complaint: %{y}<br>",
      "Count: %{x}<br>",
      "<extra></extra>"
    ),
    colors = viridis::viridis_pal()(length(unique(top_complaints_borough$borough)))
  ) |> 
  layout(
    title = "Top Complaint Types by Borough",
    xaxis = list(title = "Number of Complaints"),
    yaxis = list(title = "Complaint Type"),
    barmode = "group"
  )

plot_top_borough

```

